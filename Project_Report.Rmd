---
title: "Rurality, Neighborhood Deprivation, and Long-Term Outcomes after Critical Illness Statistical Analysis Report"
author: "Alexis Fleming"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    theme: paper # theme options: https://bootswatch.com/3/
    code_folding: "hide"
    toc: true
    number_sections: true
    df_print: paged
numbersections: true
fig_caption: true
keep_text: true
toccolor: blue
urlcolor: blue
linkcolor: blue
---


```{r chunk settings, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r setup}
## Clear the environment
rm(list = ls())

## Load required libraries
library(tidyverse)
library(Hmisc)
library(forcats) ## Collapsing factor levels
library(scales) ## If we want to make percentage plots in ggplot.
library(gridExtra) ## To combine multiple ggplots in one plot.
library(knitr) ## To use 'kable' function for some tables.
library(kableExtra) ## shape of tables created by 'kable' function.
library(mice) ## Imputation is done in another file, but we will use some functions from mice to visualize missingness and imputation patterns.
library(VIM) ## To visualize missingness patterns.
library(rms) ## To fit statistical models.
library(glue) ## For pasting subtitles, etc. in the plots.
library(broom) ## For tidying data frames, matrices, etc.

## Internal Hmisc functions to use for printing summaryM outputs (for tables)
mu <- markupSpecs$html

## html function from Hmisc package. Arguments set up as how I would like to show tables in the html output.
myhtml <- function(summaryM_object, caption){
  html(summaryM_object,
    exclude1 = FALSE, ## By default, summaryM objects will be printed, plotted, or typeset by removing redundant entries from percentage tables for categorical variables. For example, if you print the percent of females, you don't need to print the percent of males. To override this, set exclude1=FALSE.
    min.colwidth = "20cm",
    long = TRUE, ## set to TRUE to print the results for the first category on its own line, not on the same line with the variable label
    #digits = 3, ## number of significant digits to print
    pctdig = 1, ## number of digits to the right of the decimal place for printing percentages or proportions. The default is zero if what='%'
    round = "auto", ## Specify round to round the quantiles and optional mean and standard deviation to round digits after the decimal point.
    what = "%", ## specifies whether proportions or percentages are to be printed 
    # npct = "both", ## specifies which counts are to be printed to the right of percentages. You can specify "both" to print both numerator and denominator as a fraction
    # prmsd = TRUE, ## set to TRUE to print mean and SD after the three quantiles, for continuous variables
    # brmsd = TRUE, ## set to TRUE to put the mean and standard deviation on a separate line, for html
    middle.bold = TRUE, ## set to TRUE to have LaTeX use bold face for the middle quantile
    # msdsize = mu$smaller, ## defaults to NULL to use the current font size for the mean and standard deviation if prmsd is TRUE.
    # outer.size = mu$smaller, ## the font size for outer quantiles
    # rowsep = TRUE, ## if html is TRUE, instructs the function to use a horizontal line to separate variables from one another. Recommended if brmsd is TRUE. (This doesn't seem to be working)
    caption = caption,
    prn = F, ## set to TRUE to print the number of non-missing observations on the current (row) variable. The default is to print these only if any of the counts of non-missing values differs from the total number of non-missing values of the left-hand-side variable.
    prN = F ## set to TRUE to print the number of non-missing observations on rows that contain continuous variables.
  )
}

## Set Working Directory
setwd("~/School/Spring 2024/Collab II/Project/Analysis Report")

## Source necessary R files
# source(".R")

```

```{r data loading}
## Load the data to be used for the tables, plots, and analysis
load("od_data.RData")
load("data_gen.RData")
load("CONSORT_data.RData")

```


# Introduction

**Background:** Residents of rural counties in the United States are older, more impoverished, and have worse healthcare access along with higher rates of smoking, obesity, hypertension, heart and lung disease, diabetes, stroke, and sepsis. Currently, it is unknown if outcomes after critical illness differ between rural and urban residents. Rurality, Neighborhood Deprivation, and Long-Term Outcomes after Critical Illness is an observational cohort study combining cohorts from two large prospective cohort studies conducted at Vanderbilt and the Nashville VA Medical Center with the same enrollment criteria: the Bringing to Light the Risk Factors and Incidence of Neuropsychological Dysfunction in ICU Survivors (BRAIN-ICU) study and the Delirium and Dementia in Veterans Surviving ICU Care (MIND-ICU) study. These cohorts included critically ill adults with acute respiratory failure or shock treated in an ICU, and survivors were followed out to 12 months with repeat assessments of several patient-centered outcomes. The principal investigator is Dr. MF Mart, M.D., M.Sc.


**Study Questions:**

1.	Is rurality, as measured by the Rural-Urban Commuting Area (RUCA) codes, adjusted for area socioeconomic deprivation, associated with long-term cognition, disability, and quality of life in survivors of critical illness?
2.	Is the interaction between rurality and area deprivation associated with long-term cognition, disability, and quality of life in survivors of critical illness?


**Hypothesis:** We hypothesize that increasing rurality and neighborhood deprivation are associated with worse cognitive, disability, and quality of life outcomes in ICU survivors. We also hypothesize that the interaction between rurality and neighborhood deprivation is associated with worse outcomes after critical illness. 


**Primary outcomes for this study include:** global and executive function cognition, disability in basic activities of daily livings (ADLs), disability in instrumental activities of daily living (iADLs), and health-related quality of life (HRQoL). Rurality is measured through the Rural-Urban Commuting Area (RUCA) codes. The Area Deprivation Index ranks neighborhoods by socioeconomic disadvantage at the census block level. It includes factors for the theoretical domains of income, education, employment, and housing quality. The national ADI index ranges from 1 - least disadvantaged to 100 - most disadvantaged. 


# CONSORT Diagram

```{r consort diagram plot, fig.width=10, fig.height=8}
## Plot the consort diagram (letter size)
consort_plot
```


# Cohort Characteristics

**Primary Diagnosis at ICU Admission was recoded to the levels in the provided SAP. Need double checking for what variable category goes in what SAP factor level.**

```{r table 1}
# using code from VIOLET-BUD report

fu_3mo_cohort_dat <- 
  fu_3mo_dat %>% 
  filter(id %in% eval_3m_cohort_ids)

fu_12mo_cohort_dat <- 
  fu_12mo_dat %>% 
  filter(id %in% eval_12m_cohort_ids)

tb1_dat <- 
  full_join(fu_0mo_dat, fu_3mo_cohort_dat) %>% 
  full_join(fu_12mo_cohort_dat) %>% 
  mutate(fu.period = factor(fu.period, levels = c("0 Month", "3 Month", "12 Month")),
         hospdis.loc = fct_collapse(hospdis.loc, 
                                    Home = "Home",
                                    Facility = c("Another Hospital", "Hospice", "LTAC", "Nursing Home", "Other", "Rehabilitation Facility")), 
         hospdis.loc = factor(hospdis.loc, levels = c("Home", "Facility"), ordered = T),
         admit.dx = fct_collapse(admit.dx,
                                 `Surgical Procedure` = c("Colonic surgery", "ENT surgery", "Gastric surgery", "Hepatobiliary/pancreatic surgery", "Obstetrical/gynecologic surgery", "Orthopedic surgery", "Urologic surgery", "Vascular surgery"), 
                                 `Other Diagnosis` = c("Other", "Other infectious disease", "Other pulmonary", "Cirrhosis/hepatic failure", "Coagulopathy", "COPD/asthma", "Hemorrhagic shock", "Malignancy", "Metabolic/endocrine", "Metabolic acidosis, hypovolemia, or electrolyte disturbance", "Renal failure", "Transplants (excluding liver)"),
                                 `Sepsis or Sepsis-Associated ARDS` = c("Sepsis, ARDS due to infection or septic shock"),
                                 `Cardiogenic Shock, Myocardial Infarction, or Dysrhythmia` = c("Acute MI", "Arrhythmia", "CHF/cardiogenic shock"),
                                 `Acute Respiratory Failure` = c("ARDS without infection"),
                                 `Airway Protection/Upper Airway Obstruction` = c("Airway protection/UAO"),
                                 `Neurologic Disease or Seizures` = c("Neurological disease", "Seizures/status epilepticus"),
                                 `Gastrointestinal Disease` = c("GI bleed")
                                 ), 
         admit.dx = factor(admit.dx,
                           levels = c("Sepsis or Sepsis-Associated ARDS",
                                      "Cardiogenic Shock, Myocardial Infarction, or Dysrhythmia",
                                      "Acute Respiratory Failure", 
                                      "Airway Protection/Upper Airway Obstruction",
                                      "Surgical Procedure",
                                      "Neurologic Disease or Seizures",
                                      "Gastrointestinal Disease",
                                      "Other Diagnosis"), ordered = T))

## For the table look
tb1_df <- tb1_dat %>% 
  select(fu.period, age.enroll, sex.pp, edu, charlson.score, iqcode.score.e, adl.e, faq.e, sofa.mod, delcoma.s.imp, vent.los.tot.s, hosp_type, bmi, frailty_numeric, admit.dx, num.apache, sofa, icudays.sevseptic.s, icu.los.tot, hosp.los, hospdis.loc, `RUCA Primary Code 2000`) %>% 
  rename(ruca.codes = `RUCA Primary Code 2000`) %>% 
  mutate(frailty_numeric = as.integer(frailty_numeric))


# assign nice variable labels
label(tb1_df$age.enroll) <- "Age at Enrollment"
label(tb1_df$sex.pp) <- "Sex"
label(tb1_df$edu) <- "Years of Education"
label(tb1_df$charlson.score) <- "Charlson Comorbidity Index"
label(tb1_df$adl.e) <- "Katz ADL at Enrollment"
label(tb1_df$faq.e) <- "FAQ at Enrollment"
label(tb1_df$delcoma.s.imp) <- "Delirium and Coma Duration, Days"
label(tb1_df$vent.los.tot.s) <- "Days on Mechanical Ventilation"
label(tb1_df$hosp_type) <- "Hospital Type"
label(tb1_df$bmi) <- "Body Mass Index"
label(tb1_df$frailty_numeric) <- "Clinical Frailty Score at Enrollment"
label(tb1_df$admit.dx) <- "Primary Diagnosis at ICU Admission"
label(tb1_df$num.apache) <- "APACHE II at Enrollment"
label(tb1_df$sofa) <- "SOFA at Enrollment"
label(tb1_df$icudays.sevseptic.s) <- "Days of Severe Sepsis / Septic Shock                          "
label(tb1_df$icu.los.tot) <- "ICU Length of Stay, Days"
label(tb1_df$hosp.los) <- "Hospital Length of Stay, Days"
label(tb1_df$hospdis.loc) <- "Discharge Location"
label(tb1_df$ruca.codes) <- "Rural-Urban Commuting Area Codes"


## LHS of table 1 in summaryM function
tb1_lhs <- "age.enroll + sex.pp + edu + bmi + charlson.score + frailty_numeric + adl.e + faq.e + ruca.codes + hosp_type + admit.dx + num.apache + sofa + icudays.sevseptic.s + vent.los.tot.s + delcoma.s.imp + icu.los.tot + hosp.los + hospdis.loc"

tb1 <- summaryM(as.formula(paste(tb1_lhs, "fu.period", sep = " ~ ")),
                 data = tb1_df,
                continuous = 6)

## Print table
myhtml(tb1, caption = "Table 1: Patient Characteristics by Follow-Up Cohort")
```



# EDA

## Independent Variables
Descriptions from SAP:

*	Rural-Urban Commuting Areas (RUCA) Codes [will need to download this and link to FIPS code (geoid) from the data]
    +	Classification from 1 (most urban) to 10 (most rural)
    +	Constructs: metropolitan/micropolitan/small town/rural characteristics; commuting flows 
*	Area Deprivation Index (ADI) [will need to download this from the ADI webpage at the census tract level]
    +	Census block groups scoring from 1 (least disadvantaged) to 100 (most disadvantaged)
    +	Constructs in ADI: education, employment status, median family income, income disparity, median home value, median monthly mortgage or rent, owner-occupied housing, single parent households, households without motor vehicle or telephone, housing without plumbing, housing with more than 1 person per room
    +	A patientâ€™s primary address can be linked to a census block using the Census Geocoder tool and then linked to an ADI score
*	RUCA*ADI Interaction Term


```{r Indep Vars EDA}

```



## Dependent Variables
Descriptions from SAP:

*	RBANS at 3 and 12 months [rbans.global.score by fu.period]
*	Trails B at 3 and 12 months [trail.b.tscore by fu.period]n
*	Katz (ADLs) at 3 and 12 months [adl.totscore by fu.period]
*	FAQ (iADLs) at 3 and 12 months [faq.totscore by fu.period]
*	SF-36 at 3 and 12 months
    +	PCS [sf36.pcs by fu.period]
    +	MCS [sf36.mcs by fu.period]


```{r Dep Vars EDA}

```


## Pre-Specified Covariates
Descriptions from SAP:

*	Age (restricted cubic splines) [age.enroll]
*	Charlson Comorbidity Index [charlson.score]
*	IQCODE (for cognitive outcomes models) [iqcode.score.e]
*	Baseline Katz (for disability models) [adl.e]
*	Baseline FAQ (for disability models) [faq.e]
*	Mean Modified Daily SOFA [sofa.mod]
*	Days of Delirium/Coma [delcoma.s.imp]
*	Days of Mechanical Ventilation [vent.los.tot.s]
*	Education [edu]
*	Sex [sex.pp]
*	Hospital Type (VA versus Civilian) [14001 onwards - VA patients]


```{r Pre-Specified Covars EDA}

```



# Missing Data

Missingness from the primary cohort in baseline data of pre-specified covariates minus the 94 missing geoid

```{r plot baseline missingness pattern, echo=TRUE, results='hide', fig.width=10, fig.height=6}
# code from the VIOLET-BUD report

missing_baseline_df <- fu_0mo_dat %>% 
  filter(is.na(geoid) == F) %>% 
  select(age.enroll, charlson.score, iqcode.score.e, adl.e, faq.e, sofa.mod,
         delcoma.s.imp, vent.los.tot.s, edu,
         sex.pp, hosp_type)

colnames(missing_baseline_df) <- c("Age", "Charlson Comorbidity Index", "IQCODE", "Katz ADL", "FAQ", "Mean Mod. Daily SOFA", "Days of Delirium/Coma", "Days on Mech. Ventilation", "Education", "Sex", "Hospital Type")

missing_pattern <- VIM::aggr(missing_baseline_df,
                             col = c("lightblue", "slategray"), ## colors of missing and observed data.
                             numbers = TRUE, ## whether the proportion or frequencies of the different combinations should be represented by numbers.
                             prop = c(TRUE, FALSE), ## Show the proportion in the left-plot and actual numbers in the right plot.
                             sortVars = TRUE, ## whether the variables should be sorted by the number of missing/imputed values.
                             labels = names(missing_baseline_df),
                             cex.axis = 1, ## the character expansion factor to be used for the axis annotation.
                             cex.lab = 1, ## axis label size.
                             gap = 1.5, ## if combined is FALSE (default), a numeric value giving the distance between the two plots in margin lines.
                             ylab = c("Proportion of Missing Values", "Missing Data Pattern"),
                             oma = c(15, 4.5, 4.5, 4.5) ## oma: A vector of the form c(bottom, left, top, right) giving the size of the outer margins in lines of text
)
```


Missingness of outcomes for 3-month follow-up cohort
```{r plot outcomes missingness 3mo cohort, echo=TRUE, results='hide', fig.width=10, fig.height=7}
missing_outcomes_df <- rbind(fu_3mo_cohort_dat, fu_12mo_cohort_dat) %>% 
  select(fu.period, rbans.global.score, trail.b.tscore, adl.totscore, faq.totscore, sf36.pcs, sf36.mcs)

colnames(missing_outcomes_df) <- c("fu.period", "RBANS Global", "Trails B", "Katz (ADLs)", "FAQ (iADLs)", "SF-36 PCS", "SF-36 MCS")

missing_pattern <- VIM::aggr(missing_outcomes_df %>% filter(fu.period == "3 Month") %>% select(-c(fu.period)),
                             col = c("lightblue", "slategray"), ## colors of missing and observed data.
                             numbers = TRUE, ## whether the proportion or frequencies of the different combinations should be represented by numbers.
                             prop = c(TRUE, FALSE), ## Show the proportion in the left-plot and actual numbers in the right plot.
                             sortVars = TRUE, ## whether the variables should be sorted by the number of missing/imputed values.
                             labels = names(missing_outcomes_df %>% select(-c(fu.period))),
                             cex.axis = 1, ## the character expansion factor to be used for the axis annotation.
                             cex.lab = 1, ## axis label size.
                             gap = 1.5, ## if combined is FALSE (default), a numeric value giving the distance between the two plots in margin lines.
                             ylab = c("Proportion of Missing Values", "Missing Data Pattern"),
                             oma = c(15, 4.5, 4.5, 4.5) ## oma: A vector of the form c(bottom, left, top, right) giving the size of the outer margins in lines of text
)
```


Missingness of outcomes for 12-Month follow-up cohort
```{r plot outcomes missingness 12mo cohort, echo=TRUE, results='hide', fig.width=10, fig.height=7}

missing_pattern <- VIM::aggr(missing_outcomes_df %>% filter(fu.period == "12 Month") %>% select(-c(fu.period)),
                             col = c("lightblue", "slategray"), ## colors of missing and observed data.
                             numbers = TRUE, ## whether the proportion or frequencies of the different combinations should be represented by numbers.
                             prop = c(TRUE, FALSE), ## Show the proportion in the left-plot and actual numbers in the right plot.
                             sortVars = TRUE, ## whether the variables should be sorted by the number of missing/imputed values.
                             labels = names(missing_outcomes_df %>% select(-c(fu.period))),
                             cex.axis = 1, ## the character expansion factor to be used for the axis annotation.
                             cex.lab = 1, ## axis label size.
                             gap = 1.5, ## if combined is FALSE (default), a numeric value giving the distance between the two plots in margin lines.
                             ylab = c("Proportion of Missing Values", "Missing Data Pattern"),
                             oma = c(15, 4.5, 4.5, 4.5) ## oma: A vector of the form c(bottom, left, top, right) giving the size of the outer margins in lines of text
)
```


Imputation of 94 missing geoids/RUCA/ADI?
```{r}


```


# Descriptives of Outcomes

```{r table 2}
tb2_df <- 
  full_join(fu_3mo_cohort_dat, fu_12mo_cohort_dat) %>% 
  mutate(fu.period = factor(fu.period, levels = c("3 Month", "12 Month"), ordered = T)) %>% 
  select(c(1:3, 35:40))


# assign nice variable labels
label(tb2_df$rbans.global.score) <- "RBANS Global Composite Score"
label(tb2_df$trail.b.tscore) <- "Trails B T-Score"
label(tb2_df$adl.totscore) <- "Katz (ADLs) Total Score"
label(tb2_df$faq.totscore) <- "FAQ (iADLs) Total Score"
label(tb2_df$sf36.pcs) <- "SF-36 Physical Component Score"
label(tb2_df$sf36.mcs) <- "SF-36 Mental Component Score                          "


## LHS of table 2 in summaryM function
tb2_lhs <- "rbans.global.score + trail.b.tscore + adl.totscore + faq.totscore + sf36.pcs + sf36.mcs"

tb2 <- summaryM(as.formula(paste(tb2_lhs, "fu.period", sep = " ~ ")),
                 data = tb2_df)

## Print table
myhtml(tb2, caption = "Table 2: Outcomes by Follow-Up Cohort")
```




# Model Associations

Table 3: 25 vs 75th percentile of exposures and point estimates?
```{r table 3}

```



# Interaction Plots


```{r interaction plots}

```





# References

$^1$ Pandharipande, P. P., Girard, T. D., Jackson, J. C., Morandi, A., Thompson, J. L., Pun, B. T., ... & Ely, E. W. (2013). Long-term cognitive impairment after critical illness. New England Journal of Medicine, 369(14), 1306-1316.

$^2$ Reference 2




# Computing Environment
```{r, echo = FALSE, results = "hide"}
sesinfo <- sessionInfo()
Rver <- sesinfo$R.version$version.string
platfm <- sesinfo$platform

basep <- sesinfo$basePkgs[1]
for (i in 2:length(sesinfo$basePkgs)){
  basep <- paste(basep,", ",sesinfo$basePkgs[i],sep="")
}

pkgs <- installed.packages()
otherp <- paste(names(sesinfo$otherPkgs[1])," ",pkgs[which(row.names(pkgs) == names(sesinfo$otherPkgs[1])),3], ", ",sep="")
for (i in 2:(length(names(sesinfo$otherPkgs))-1)){
  otherp <- paste(otherp, names(sesinfo$otherPkgs[i])," ",pkgs[which(row.names(pkgs) == names(sesinfo$otherPkgs[i])),3], ", ",sep="")
}
otherp <- paste(otherp, names(sesinfo$otherPkgs[i+1])," ",pkgs[which(row.names(pkgs) == names(sesinfo$otherPkgs[i+1])),3], nsep="")
otherp <- otherp[1]

loadp <- paste(names(sesinfo$loadedOnly[1])," ",pkgs[which(row.names(pkgs) == names(sesinfo$loadedOnly[1])),3], ", ",sep="")
for (i in 2:(length(names(sesinfo$loadedOnly))-1)){
  loadp <- paste(loadp, names(sesinfo$loadedOnly[i])," ",pkgs[which(row.names(pkgs) == names(sesinfo$loadedOnly[i])),3], ", ",sep="")
}
loadp <- paste(loadp, names(sesinfo$loadedOnly[i+1])," ",pkgs[which(row.names(pkgs) == names(sesinfo$loadedOnly[i+1])),3], sep="")
loadp <- loadp[1]
```

To maintain high standards and reproducible research, we provide the computing environment under which all analyses were conducted. These analyses were done using the following version of R, the operating system, and add-on packages and others:

* `r Rver`, `r Sys.info()[c('sysname', 'release', 'machine')]`
* Base packages: `r basep`
* Other packages: `r otherp`
* Loaded packages via the namespace but not attached: `r loadp`
